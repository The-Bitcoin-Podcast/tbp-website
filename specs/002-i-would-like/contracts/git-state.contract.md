# Git State Tracking Contract

**Module**: Git History Scanner
**Input**: Git repository path
**Output**: SyncState with synced video IDs

## Contract: Build Sync State

**Function Signature**:
```typescript
async function buildSyncState(
  repoPath: string,
  episodeDirectory: string = 'content/episodes'
): Promise<SyncState>

interface SyncState {
  syncedVideoIds: Set<string>
  lastSyncTimestamp?: Date
  episodeCount: number
  syncHistory: SyncRecord[]
}

interface SyncRecord {
  videoId: string
  episodePath: string
  syncedAt: Date
  commitHash: string
}
```

**Git Command Executed**:
```bash
git log --diff-filter=A --format="%H|%ai|%s" --name-only -- content/episodes/*.md
```

**Expected Git Log Output Format**:
```
abc123def456|2024-01-15 10:30:00 -0500|Sync episode 1: Bitcoin Basics (YouTube: dQw4w9WgXcQ)
content/episodes/001-bitcoin-basics.md

def789ghi012|2024-01-20 14:45:00 -0500|Sync episode 2: Decentralization (YouTube: xyz789abc)
content/episodes/002-decentralization.md
```

**Parsing Algorithm**:
1. Run git log with --diff-filter=A (added files only)
2. Filter results to episode directory pattern
3. For each commit:
   - Extract commit hash, timestamp, message
   - Extract file path from diff
   - Use `git show {hash}:{path}` to get file content at that commit
   - Parse frontmatter with gray-matter
   - Extract youtubeId from frontmatter
   - Build SyncRecord

**Output Example**:
```typescript
{
  syncedVideoIds: Set(['dQw4w9WgXcQ', 'xyz789abc']),
  lastSyncTimestamp: new Date('2024-01-20T14:45:00-05:00'),
  episodeCount: 2,
  syncHistory: [
    {
      videoId: 'dQw4w9WgXcQ',
      episodePath: 'content/episodes/001-bitcoin-basics.md',
      syncedAt: new Date('2024-01-15T10:30:00-05:00'),
      commitHash: 'abc123def456'
    },
    {
      videoId: 'xyz789abc',
      episodePath: 'content/episodes/002-decentralization.md',
      syncedAt: new Date('2024-01-20T14:45:00-05:00'),
      commitHash: 'def789ghi012'
    }
  ]
}
```

**Error Handling**:
```typescript
// Throw if:
- repoPath is not a valid git repository
- episodeDirectory pattern returns no results (may be valid - no episodes yet)
- git command fails (permissions, corrupt repo)
- Frontmatter parsing fails for any episode (log warning, skip that file)
- youtubeId missing from frontmatter (log warning, skip that file)

// Return empty SyncState if:
- No commits found (fresh repo or no episodes synced yet)
```

---

## Contract: Check if Video is Synced

**Function Signature**:
```typescript
function isVideoSynced(
  videoId: string,
  syncState: SyncState
): boolean
```

**Logic**:
```typescript
return syncState.syncedVideoIds.has(videoId)
```

**Input/Output Examples**:
```typescript
const state = { syncedVideoIds: Set(['abc123', 'def456']), ... }

isVideoSynced('abc123', state)  → true
isVideoSynced('xyz789', state)  → false
isVideoSynced('', state)        → false (invalid ID)
```

---

## Contract: Get Last Sync Timestamp

**Function Signature**:
```typescript
function getLastSyncTimestamp(syncState: SyncState): Date | null
```

**Logic**:
```typescript
if (syncState.syncHistory.length === 0) return null
return syncState.syncHistory[syncState.syncHistory.length - 1].syncedAt
```

**Usage for Incremental Sync**:
```typescript
const lastSync = getLastSyncTimestamp(state)
const publishedAfter = lastSync?.toISOString() || null

// Pass to YouTube API search:
// GET /search?publishedAfter={publishedAfter}&...
```

---

## Contract: Commit Sync Results

**Function Signature**:
```typescript
async function commitSyncResults(
  episodeFiles: string[],
  commitMessage: string
): Promise<string>  // Returns commit hash
```

**Git Commands Executed**:
```bash
git add {episodeFiles...}
git commit -m "{commitMessage}"
git rev-parse HEAD  # Get commit hash
```

**Commit Message Format**:
```
Sync {count} episode(s): {episode numbers}

- Episode {num}: {title} (YouTube: {videoId})
- Episode {num}: {title} (YouTube: {videoId})
...

Generated by youtube-sync script
```

**Example**:
```
Sync 3 episode(s): 42-44

- Episode 42: Bitcoin Basics (YouTube: dQw4w9WgXcQ)
- Episode 43: Decentralization (YouTube: xyz789abc)
- Episode 44: Future of Money (YouTube: abc123def)

Generated by youtube-sync script
```

**Error Handling**:
```typescript
// Throw if:
- Git add fails (file not found, permissions)
- Git commit fails (nothing to commit, conflicts)
- Commit message is empty

// Validate before commit:
- All files in episodeFiles array exist
- All files are in episode directory
- At least one file to commit
```

---

## Contract: Validate Git Repository

**Function Signature**:
```typescript
async function validateGitRepository(repoPath: string): Promise<boolean>
```

**Validation Checks**:
```typescript
1. Directory exists
2. `.git` directory exists
3. `git status` command succeeds
4. Working tree is clean (no uncommitted changes to episode files)
```

**Error Messages**:
```typescript
// If not a git repo:
throw new Error(`Not a git repository: ${repoPath}`)

// If dirty working tree:
throw new Error(`Uncommitted changes in ${episodeDirectory}. Commit or stash before syncing.`)
```

---

## Contract: Extract Video ID from Frontmatter

**Function Signature**:
```typescript
function extractVideoIdFromFrontmatter(fileContent: string): string | null
```

**Implementation**:
```typescript
import matter from 'gray-matter'

function extractVideoIdFromFrontmatter(fileContent: string): string | null {
  try {
    const { data } = matter(fileContent)
    return data.youtubeId || null
  } catch (error) {
    console.warn(`Failed to parse frontmatter: ${error.message}`)
    return null
  }
}
```

**Input/Output Examples**:
```typescript
extractVideoIdFromFrontmatter(`
---
title: "Bitcoin Basics"
youtubeId: "dQw4w9WgXcQ"
---
Content here...
`)
→ "dQw4w9WgXcQ"

extractVideoIdFromFrontmatter(`
---
title: "No Video ID"
---
Content...
`)
→ null

extractVideoIdFromFrontmatter("Invalid markdown")
→ null  // Logs warning, returns null
```

---

## Contract: Performance Requirements

**Constraints**:
- Git log scan for 500 episodes: **< 2 seconds**
- Frontmatter parsing for 500 files: **< 1 second**
- Total sync state build: **< 3 seconds**

**Optimization Strategies**:
- Use `@napi-rs/simple-git` (native bindings, faster than pure JS)
- Parse only frontmatter, skip file body (gray-matter excerpt mode)
- Cache SyncState during script execution (build once, reuse)
- Use git's native filtering (--diff-filter, -- path) instead of post-processing

---

## Contract: State Invariants

**Guarantees**:
1. **Uniqueness**: Each videoId appears at most once in syncedVideoIds Set
2. **Chronological Order**: syncHistory is sorted by syncedAt ascending
3. **Consistency**: episodeCount === syncedVideoIds.size === syncHistory.length
4. **Commit Integrity**: Every SyncRecord.commitHash is a valid git SHA
5. **Path Validity**: Every SyncRecord.episodePath exists in git history at that commit

**Validation Function**:
```typescript
function validateSyncState(state: SyncState): void {
  assert(state.episodeCount === state.syncedVideoIds.size)
  assert(state.episodeCount === state.syncHistory.length)

  // Check chronological order
  for (let i = 1; i < state.syncHistory.length; i++) {
    assert(state.syncHistory[i].syncedAt >= state.syncHistory[i - 1].syncedAt)
  }

  // Check uniqueness
  const videoIds = state.syncHistory.map(r => r.videoId)
  assert(new Set(videoIds).size === videoIds.length)
}
```

---

## Contract Tests Location

Tests implementing these contracts:
- `/home/petty/Github/tbp/quartz/tests/integration/git-state.test.ts`
- `/home/petty/Github/tbp/quartz/tests/unit/git-utils.test.ts`

Each test validates:
- Git command execution and output parsing
- Frontmatter extraction from git show output
- SyncState invariants maintained
- Error handling for corrupt data
- Performance benchmarks for large repos
